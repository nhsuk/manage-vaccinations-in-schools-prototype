{% extends "_layouts/default.njk" %}

{% set title = __("upload.show.title", { upload: upload }) %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [{
      text: __("programme.list.title"),
      href: "/programmes"
    }, {
      text: data.programmes[upload.programme_pid].type,
      href: "/programmes/" + upload.programme_pid
    }],
    text: __("programme.uploads.title"),
    href: "/programmes/" + upload.programme_pid + "/uploads"
  }) }}
{% endblock %}

{% block content %}
  {{ super() }}

  {{ heading({
    title: title
  }) }}

  {{ card({
    heading: __("upload.show.summary"),
    headingClasses: "nhsuk-heading-m",
    descriptionHtml: summaryList({
      rows: summaryRows(upload, {
        created: {},
        created_user_uid: {
          value: users[upload.created_user_uid].fullName
        },
        programme_pid: {
          value: data.programmes[upload.programme_pid].type
        },
        invalid: {
          value: __n("upload.invalid.count", invalid.length)
        },
        exact: {
          value: __n("upload.exact.count", exact.length)
        },
        inexact: {
          value: __n("upload.inexact.count", inexact.length)
        }
      })
    })
  }) }}

  {% set inexactRecordRows = [] %}
  {% for vaccination in inexact %}
    {% set inexactRecordRows = inexactRecordRows | push([
      {
        header: __("record.fullName.label"),
        html: vaccination.record.fullName
      },
      {
        header: __("vaccination.review.issue.label"),
        html: __("vaccination.review.issue.text")
      },
      {
        header: __("vaccination.review.actions.label"),
        html: actionList({
          items: [{
            text: "Review",
            href: upload.uri + "/vaccinations/" + vaccination.uuid + "/review"
          }]
        })
      }
    ]) %}
  {% endfor %}

  {{ actionTable({
    id: "inexact-records",
    sort: "name",
    panel: true,
    heading: __n("upload.inexact.count", inexact.length),
    responsive: true,
    head: [
      {
        text: __("record.label"),
        attributes: { "no-sort": "no-sort" }
      },
      {
        text: __("vaccination.review.issue.label"),
        attributes: { "no-sort": "no-sort" }
      },
      {
        text: __("vaccination.review.actions.label"),
        attributes: { "no-sort": "no-sort" }
      }
    ],
    rows: inexactRecordRows
  }) if inexact.length }}

  {% set vaccinationRows = [] %}
  {% for vaccination in vaccinations %}
    {% set vaccinationRows = vaccinationRows | push([
      {
        header: __("record.fullName.label"),
        html: link(vaccination.uri, vaccination.record.fullName)
      },
      {
        header: __("record.nhsn.label"),
        html: vaccination.record.formatted.nhsn or "Not provided"
      },
      {
        header: __("record.dob.label"),
        html: vaccination.record.formatted.dob
      },
      {
        header: __("record.postalCode.label"),
        html: vaccination.record.postalCode
      },
      {
        header: __("vaccination.created.label"),
        html: vaccination.formatted.created_date
      }
    ]) %}
  {% endfor %}

  {{ actionTable({
    id: "vaccinations",
    sort: "name",
    panel: true,
    heading: __n("upload.vaccinations.count", upload.vaccinations.length),
    responsive: true,
    head: [
      { text: __("record.fullName.label") },
      { text: __("record.nhsn.label") },
      { text: __("record.dob.label") },
      { text: __("record.postalCode.label") },
      { text: __("vaccination.created.label") }
    ],
    rows: vaccinationRows
  }) }}
{% endblock %}
