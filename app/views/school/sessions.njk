{% from "school/_navigation.njk" import schoolNavigation with context %}

{% extends "_layouts/form.njk" %}

{% set gridColumns = "full" %}
{% set hideConfirmButton = true %}
{% set title = school.name + " â€“ " + __("school.sessions.title") %}

{% set activeSession = sessions | selectattr("isActive") | first %}
{% set completedSessions = sessions | selectattr("isCompleted") %}
{% set plannedSessions = sessions | selectattr("isPlanned") %}

{% macro sessionCard(session) %}
  {% call card({
    classes: "app-card--compact",
    heading: session.formatted.date,
    headingClasses: "nhsuk-heading-s",
    headingLevel: 4,
    href: session.uri
  }) %}
    {{ summaryList({
      classes: "app-summary-list--full-width",
      rows: summaryRows(session, {
        patients: {},
        programmes: {},
        yearGroups: {},
        consentWindow: {}
      })
    }) }}

    {{ appButtonGroup({
      buttons: [
        {
          classes: "nhsuk-button--secondary nhsuk-button--small",
          text: __("session.edit.title"),
          href: session.uri + "/edit"
        },
        {
          classes: "app-button--secondary-warning nhsuk-button--small",
          text: "Delete",
          href: session.uri + "/delete"
        } if session.consentWindow != ConsentWindow.Open
      ]
    }) if not session.isCompleted }}
  {% endcall %}
{% endmacro %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [{
      text: __("home.show.title"),
      href: "/"
    }, {
      text: __("school.list.title"),
      href: "/schools"
    }, {
      text: school.name,
      href: school.uri
    }]
  }) }}
{% endblock %}

{% block form %}
  {{ super() }}

  {{ schoolNavigation({
    school: school,
    view: "sessions"
  }) }}

  {{ button({
    classes: "nhsuk-button--secondary",
    text: __("session.new.label"),
    href: "/sessions/new"
  }) }}

  {% if activeSession %}
    {{ appHeading({
      title: __("school.sessions.isActive"),
      level: 3,
      size: "m"
    }) }}

    <div class="nhsuk-grid-row nhsuk-card-group">
      <div class="nhsuk-grid-column-one-third nhsuk-card-group__item">
        {{ sessionCard(activeSession) if activeSession }}
      </div>
    </div>
  {% endif %}

  {% if plannedSessions.length %}
    {{ appHeading({
      title: __("school.sessions.isPlanned"),
      level: 3,
      size: "m"
    }) }}

    <div class="nhsuk-grid-row nhsuk-card-group">
      {% for session in plannedSessions %}
        <div class="nhsuk-grid-column-one-third nhsuk-card-group__item">
          {{ sessionCard(session) }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if completedSessions.length %}
    {{ appHeading({
      title: __("school.sessions.isCompleted"),
      level: 3,
      size: "m"
    }) }}

    <div class="nhsuk-grid-row nhsuk-card-group">
      {% for session in completedSessions %}
        <div class="nhsuk-grid-column-one-third nhsuk-card-group__item">
          {{ sessionCard(session) }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
