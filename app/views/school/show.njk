{% from "school/_navigation.njk" import schoolNavigation with context %}

{% from "_macros/patient-search.njk" import appPatientSearch with context %}

{% extends "_layouts/form.njk" %}

{% set gridColumns = "full" %}
{% set hideConfirmButton = true %}
{% set title = school.name + " â€“ " + __("school.patients.title") %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [{
      text: __("home.show.title"),
      href: "/"
    }, {
      text: __("school.list.title"),
      href: "/schools"
    }]
  }) }}
{% endblock %}

{% block form %}
  {{ super() }}

  {{ schoolNavigation({
    school: school,
    view: "show"
  }) }}

  {{ button({
    classes: "nhsuk-button--secondary",
    href: "/uploads/new?type=" + UploadType.School + "&urn=" + school.urn,
    text: __("session.upload-class-list.title")
  }) }}

  <div class="nhsuk-grid-row">
    <app-auto-submit class="app-grid-column-filters">
      {{ appPatientSearch({
        clear: school.uri,
        radioFilters: radioFilters
      }) }}
    </app-auto-submit>

    <div class="app-grid-column-results">
      {{ warningCallout({
        heading: __("school.patientsMissingNhsNumber.title"),
        html: link(school.uri + "?option=hasMissingNhsNumber", __mf("school.patientsMissingNhsNumber.count", {
          count: school.patientsMissingNhsNumber.length
        })) | nhsukMarkdown
      }) if school.patientsMissingNhsNumber }}

      {{ appHeading({
        level: 2,
        size: "m",
        title: __("search.results"),
        summary: __mf("patient.results", {
          from: results.from,
          to: results.to,
          count: results.count
        }) | safe
      }) }}

      {% for patient in results.page %}
        {% set reportStatusHtml -%}
          {%- for id, patientProgramme in patient.programmes -%}
            {%- if data.programme_id | includes(id) -%}
              {{ patientProgramme.formatted.programmeStatus | nhsukMarkdown }}
            {%- endif -%}
          {%- endfor %}
        {%- endset %}

        {{ card({
          classes: "app-card--compact",
          heading: patient.fullAndPreferredNames | highlightQuery(data.q),
          headingClasses: "nhsuk-heading-s",
          headingLevel: 4,
          href: patient.uri,
          clickable: true,
          descriptionHtml: summaryList({
            rows: summaryRows(patient, {
              nhsn: {},
              dob: {},
              yearGroup: {},
              report: {
                label: __("patientSession.report.label"),
                value: reportStatusHtml
              } if data.programme_id
            })
          })
        }) }}
      {% endfor %}

      {{ pagination(pages) }}
    </div>
  </div>
{% endblock %}
