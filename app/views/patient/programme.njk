{% from "patient/_navigation.njk" import patientNavigation with context %}

{% extends "_layouts/default.njk" %}

{% set title = patient.fullName + " â€“ " + patient.programmes[programme.slug].name %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [{
      text: __("home.show.title"),
      href: "/"
    }, {
      text: __("patient.list.title"),
      href: "/patients"
    }]
  }) }}
{% endblock %}

{% block content %}
  {{ super() }}

  {{ patientNavigation({
    patient: patient
  }) }}

  {% set ttcvRows = [] %}
  {% for vaccination in patientProgramme.ttcv %}
    {% set ttcvRows = ttcvRows | push([
      {
        header: __("vaccination.createdAt.label"),
        text: vaccination.formatted.createdAt_date
      },
      {
        header: __("vaccination.age.label"),
        text: patient.dob | age(at=vaccination.createdAt)
      },
      {
        header: __("vaccination.programme.label"),
        html: vaccination.formatted.programmeWithSequence
      },
      {
        header: __("vaccination.ttcv.label"),
        html: loop.index | ordinal
      }
    ]) %}
  {% endfor %}

  {{ table({
    id: "ttcv",
    responsive: true,
    card: {
      heading: __("patientProgramme.ttcv.label"),
      headingLevel: 3
    },
    head: [
      { text: __("vaccination.createdAt.label") },
      { text: __("vaccination.age.label") },
      { text: __("vaccination.programme.label") },
      { text: __("vaccination.ttcv.label") }
    ],
    rows: ttcvRows
  }) if patientProgramme.ttcv }}

  {% call card({
    heading: __mf("patientProgramme.vaccinationsGiven.count", {
      count: patientProgramme.vaccinationsGiven.length
    }),
    headingLevel: 3
  }) %}
    {{ patientProgramme.formatted.statusWithNotes | nhsukMarkdown }}

    {% if patientProgramme.vaccinationsGiven.length %}
      {% for vaccination in patientProgramme.vaccinationsGiven %}
        {{ summaryList({
          card: {
            classes: "app-card--compact app-card--offset",
            heading: vaccination.formatted.vaccine_snomed,
            headingLevel: 4,
            href: vaccination.uri,
            clickable: true
          },
          rows: summaryRows(vaccination, {
            outcome: {},
            vaccine_snomed: {},
            method: {},
            site: {},
            dose: {},
            sequence: {},
            batch: {},
            location: {},
            identifiedBy: {},
            suppliedBy: {},
            createdBy: {},
            createdAt: {},
            reportedAt: {},
            protocol: {},
            note: {},
            syncStatus: {}
          })
        }) }}
      {% endfor %}
    {% endif %}

    {{ button({
      classes: "nhsuk-button--secondary nhsuk-u-margin-0",
      text: __("vaccination.new.alreadyVaccinated.dose", patientProgramme.formatted.doseDue) if patientProgramme.doseDue else __("vaccination.new.alreadyVaccinated.title"),
      href: patientProgramme.uri + "/new/vaccination"
    }) if patientProgramme.status != PatientStatus.Vaccinated and patientProgramme.eligible }}
  {% endcall %}

  {% if patientProgramme.patientSessions.length %}
    {% set patientSessionRows = [] %}
    {% for patientSession in patientProgramme.patientSessions %}
      {% set patientSessionRows = patientSessionRows | push([
        {
          header: __("session.location.label"),
          html: link(patientSession.uri, patientSession.session.location.name)
        },
        {
          header: __("session.date.label"),
          html: patientSession.session.formatted.date if patientSession.session.date else patientSession.session.status
        },
        {
          header: __("patientSession.outcome.label"),
          html: patientSession.formatted.outcome or "No outcome"
        }
      ]) %}
    {% endfor %}

    {{ table({
      id: "patient-sessions",
      sort: "name",
      responsive: true,
      card: {
        heading: __("patientProgramme.patientSessions.label"),
        headingLevel: 3
      },
      head: [
        {
          text: __("session.location.label"),
          attributes: {
            style: "width: 33%"
          }
        },
        { text: __("session.date.label") },
        { text: __("patientSession.outcome.label") }
      ],
      rows: patientSessionRows
    }) }}
  {% endif %}

  {{ card({
    heading: __("patientProgramme.auditEvents.label"),
    headingLevel: 3,
    descriptionHtml: appTimeline({
      items: timelineItems(patientProgramme.auditEvents)
    })
  }) if patientProgramme.auditEvents.length }}
{% endblock %}
