{% from "_macros/patient-search.njk" import appPatientSearch with context %}

{% extends "_layouts/form.njk" %}

{% set gridColumns = "full" %}
{% set hideConfirmButton = true %}
{% set title = __("patient.list.title") %}

{% block form %}
  {{ super() }}

  {{ appHeading({
    size: "xl",
    title: title
  }) }}

  <div class="nhsuk-grid-row">
    <app-auto-submit class="app-grid-column-filters">
      {{ appPatientSearch({
        clear: "/patients",
        radioFilters: {
          consent: ConsentOutcome,
          screen: ScreenOutcome,
          report: PatientOutcome
        }
      }) }}
    </app-auto-submit>

    <div class="app-grid-column-results">
      {{ appHeading({
        level: 2,
        size: "m",
        title: __("search.results"),
        summary: __mf("patient.results", {
          from: results.from,
          to: results.to,
          count: results.count
        }) | safe
      }) }}

      {% for patient in results.page %}
        {% set consentStatusHtml = false %}
        {% set screenStatusHtml = false %}
        {% set reportStatusHtml = false %}

        {% if data.programme_ids %}
          {% set consentStatusHtml -%}
            {%- for patientSession in patient.patientSessions -%}
              {%- if data.programme_ids | includes(patientSession.programme_id) -%}
                {%- if patientSession.consent -%}
                  <p>{{ patientSession.formatted.status.consent | safe }}</p>
                {%- endif -%}
              {%- endif -%}
            {%- endfor %}
          {%- endset %}

          {% set screenStatusHtml -%}
            {%- for patientSession in patient.patientSessions -%}
              {%- if data.programme_ids | includes(patientSession.programme_id) -%}
                {%- if patientSession.screen -%}
                  <p>{{ patientSession.formatted.status.screen | safe }}</p>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endset %}

          {% set reportStatusHtml -%}
            {%- for patientSession in patient.patientSessions -%}
              {%- if data.programme_ids | includes(patientSession.programme_id) -%}
                <p>{{ patientSession.formatted.status.report | safe }}</p>
              {%- endif -%}
            {%- endfor %}
          {%- endset %}
        {% endif %}

        {{ card({
          classes: "app-card--compact",
          heading: patient.fullAndPreferredNames | highlightQuery(data.q),
          headingClasses: "nhsuk-heading-s",
          headingLevel: 4,
          href: patient.uri,
          clickable: true,
          descriptionHtml: summaryList({
            rows: summaryRows(patient, {
              nhsn: {},
              dob: {},
              school: {},
              yearGroup: {},
              consent: {
                label: __("patientSession.consent.label"),
                value: consentStatusHtml
              } if data.programme_ids and consentStatusHtml,
              screen: {
                label: __("patientSession.screen.label"),
                value: screenStatusHtml
              } if data.programme_ids and screenStatusHtml,
              status: {
                label: __("patientSession.report.label"),
                value: reportStatusHtml
              } if data.programme_ids and reportStatusHtml
            })
          })
        }) }}
      {% endfor %}

      {{ pagination(pages) }}
    </div>
  </div>
{% endblock %}
