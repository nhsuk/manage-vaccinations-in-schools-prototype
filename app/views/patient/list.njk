{% from "_macros/patient-search.njk" import appPatientSearch with context %}

{% extends "_layouts/form.njk" %}

{% set gridColumns = "full" %}
{% set hideConfirmButton = true %}
{% set title = __("patient.list.title") %}

{% block form %}
  {{ super() }}

  {{ appHeading({
    size: "xl",
    title: title
  }) }}

  <div class="nhsuk-grid-row">
    <app-auto-submit class="app-grid-column-filters">
      {{ appPatientSearch({
        clear: "/patients"
      }) }}
    </app-auto-submit>

    <div class="app-grid-column-results">
      {% if initial %}
        {{ appHeading({
          level: 2,
          size: "m",
          title: __("search.results"),
          summary: __("search.initial") | safe
        }) }}
      {% else %}
        {{ appHeading({
          level: 2,
          size: "m",
          title: __("search.results"),
          summary: __mf("patient.results", {
            from: results.from,
            to: results.to,
            count: results.count
          }) | safe
        }) }}

        {% for patient in results.page %}
          {% set reportStatusHtml -%}
            {%- if data.programme_id %}
              {%- for id, patientProgramme in patient.programmes -%}
                {%- if data.programme_id | includes(id) -%}
                  {{ patientProgramme.formatted.programmeStatus | nhsukMarkdown }}
                {%- endif -%}
              {%- endfor %}
            {% else %}
              {%- for id, patientProgramme in patient.programmes -%}
                {{ patientProgramme.formatted.programmeStatus | nhsukMarkdown }}
              {%- endfor %}
            {% endif %}
          {%- endset %}

          {{ card({
            classes: "app-card--compact",
            heading: patient.fullAndPreferredNames | highlightQuery(data.q),
            headingClasses: "nhsuk-heading-s",
            headingLevel: 4,
            href: patient.uri,
            clickable: true,
            descriptionHtml: summaryList({
              rows: summaryRows(patient, {
                nhsn: {},
                dob: {},
                school: {},
                yearGroup: {},
                report: {
                  label: __("patientSession.report.label"),
                  value: reportStatusHtml
                }
              })
            })
          }) }}
        {% endfor %}

        {{ pagination(pages) }}
      {% endif %}
    </div>
  </div>
{% endblock %}
