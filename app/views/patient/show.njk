{% extends "_layouts/default.njk" %}

{% set title = patient.record.fullName %}
{% set view = "show" %}

{% block content %}
  <div class="nhsuk-u-width-three-quarters">
    {{ super() }}

    {{ heading({
      caption: session.location.name,
      title: title
    }) }}

    {% include "patient/_secondary-navigation.njk" %}

    <h2 class="nhsuk-heading-m nhsuk-u-visually-hidden">
      {{ __("patient.show.title") }}
    </h2>

    {{ card({
      classes: "app-card--" + patientStatus(patient).colour,
      heading: patientStatus(patient).title,
      headingClasses: "nhsuk-heading-m",
      description: patientStatus(patient).description,
      feature: true
    }) }}

    {{ card({
      heading: __("record.label"),
      headingClasses: "nhsuk-heading-m",
      descriptionHtml: summaryList({
        rows: summaryRows(patient.record, {
          nhsn: {
            classes: "app-u-monospace",
            value: patient.record.formattedNhsNumber
          },
          fullName: {},
          preferredNames: { value: patient.preferredNames },
          dob: { value: patient.record.dobWithAge },
          sex: {},
          address: { value: patient.record.formattedAddress | nl2br },
          gpSurgery: {}
        })
      })
    }) }}

    {% set consentDescriptionHtml %}
      {% if replies.length %}
        {{ status(
          __("consent." + patient.consent.key + ".status"),
          __("consent." + patient.consent.key + ".icon"),
          __("consent." + patient.consent.key + ".colour")
        ) }}
        {% set replyRows = [] %}
        {% for reply in replies | sort(false, false, "created") %}
          {% set replyColour = replyStatus(reply).colour %}
          {% set replyModifier = "grey" if reply.invalid else replyColour %}
          {% set replyRows = replyRows | push([
            {
              classes: "app-table__cell-status--" + replyModifier,
              header: __("parent.fullName.label"),
              html: link(reply.uri, reply.parent.fullName) or "Not provided"
            },
            {
              classes: "app-table__cell-status--" + replyModifier,
              header: __("reply.created.label"),
              html: reply.formattedCreated or "Not provided",
              attributes: {
                "data-sort": reply.created
              }
            },
            {
              classes: "app-table__cell-status--" + replyModifier,
              header: __("reply.decision.label"),
              text: replyDecisionHtml(reply) | safe
            }
          ]) %}
        {% endfor %}

        {{ actionTable({
          sort: "created",
          responsive: true,
          head: [
            { text: __("parent.fullName.label") },
            { text: __("reply.created.label") },
            { text: __("reply.decision.label") }
          ],
          rows: replyRows
        }) }}
      {% else %}
        {{ __("consent.NoResponse.description") | nhsukMarkdown }}
      {% endif %}
    {% endset %}

    {{ card({
      heading: __("consent.label"),
      headingClasses: "nhsuk-heading-m",
      descriptionHtml: consentDescriptionHtml
    }) }}
  </div>
{% endblock %}
