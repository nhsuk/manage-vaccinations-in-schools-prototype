{% from "patient/_navigation.njk" import patientNavigation with context %}

{% extends "_layouts/form.njk" %}

{% set hideConfirmButton = true %}
{% set gridColumns = "full" %}
{% set title = patient.initials %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [{
      text: __("home.show.title"),
      href: "/"
    }, {
      text: __("patient.list.title"),
      href: "/patients"
    }]
  }) }}
{% endblock %}

{% block form %}
  {{ super() }}

  {{ patientNavigation({
    patient: patient,
    view: "show"
  }) }}

  {% set recordDescriptionHtml %}
    {{ appStatus({
      text: patient.notice.name,
      icon: "warning",
      colour: "blue"
    }) if patient.notice }}

    {{ appStatus({
      text: __("patient.post16.status", { patient: patient }),
      icon: "warning",
      colour: "blue"
    }) if patient.post16 }}

    {{ summaryList({
      rows: summaryRows(patient, {
        nhsn: {
          changeLabel: "the childâ€™s NHS number",
          href: patient.uri + "/edit/nhsn" if patient.hasMissingNhsNumber
        },
        archiveReason: {
          other: archiveReasonOther
        },
        fullName: {},
        preferredNames: {},
        dob: { value: patient.dobWithAge },
        dod: {},
        gender: {},
        address: {},
        school: {},
        yearGroupWithRegistration: {},
        gpSurgery: {},
        parents: {}
      })
    }) }}

    {{ appButtonGroup({
      buttons: [{
        classes: "nhsuk-button--secondary",
        text: __("patient.edit.label"),
        href: patient.uri + "/edit"
      }, {
        classes: "app-button--secondary-warning",
        text: __("patient.archive.label"),
        href: patient.uri + "/archive"
      }]
    }) if not patient.archived }}
  {% endset %}

  {{ card({
    heading: recordTitle,
    headingLevel: 3,
    descriptionHtml: recordDescriptionHtml
  }) }}

  {% set vaccinationsDescriptionHtml %}
    {% set vaccinationRows = [] %}
    {% for programme in activeProgrammes %}
      {% set vaccination = patient.programmeOutcomes[programme.type] %}
      {% set vaccinationRows = vaccinationRows | push([
        {
          header: __("vaccination.programme.label"),
          html: link(patient.uri + "/programmes/" + programme.slug, programme.name)
        },
        {
          header: __("vaccination.outcome.label"),
          html: vaccination.formatted.outcomeStatus if vaccination.outcome else tag({
            classes: "nhsuk-tag--white",
            text: PatientOutcome.NoOutcomeYet
          })
        },
        {
          header: __("vaccination.note.label"),
          html: vaccination.outcome + " on " + vaccination.formatted.createdAt if vaccination.createdAt else __("patient.programmeEligibility.text", patient.programmeEligibility[programme.type])
        }
      ]) %}
    {% endfor %}

    {{ table({
      id: "vaccinations",
      sort: "createdAt",
      responsive: true,
      head: [
        { text: __("vaccination.programme.label") },
        { text: __("vaccination.outcome.label") },
        { text: __("vaccination.note.label") }
      ],
      rows: vaccinationRows
    }) }}
  {% endset %}

  {{ card({
    heading: __("patient.vaccinations.label"),
    headingLevel: 3,
    descriptionHtml: vaccinationsDescriptionHtml
  }) }}
{% endblock %}
