{% extends "_layouts/default.njk" %}

{% set paths = false %}
{% set sessionTitle = campaign.name + " session at " + session.location.name %}
{% set title = patient.record.fullName %}
{% set view = "show" %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [
      {
        text: "Home",
        href: "/dashboard"
      },
      {
        text: __("session.list.title"),
        href: "/sessions"
      },
      {
        text: sessionTitle,
        href: "/sessions/" + session.id
      }
    ]
  }) }}
{% endblock %}

{% block content %}
  <div class="nhsuk-u-width-three-quarters">
    {{ super() }}

    {{ heading({
      title: title
    }) }}

    {% include "patient/_secondary-navigation.njk" %}

    {{ card({
      classes: "app-card--" + patientStatus(patient).colour,
      heading: patientStatus(patient).title,
      headingClasses: "nhsuk-heading-m",
      description: patientStatus(patient).description,
      feature: true
    }) }}

    {{ card({
      heading: __("patient.record.label"),
      headingClasses: "nhsuk-heading-m",
      descriptionHtml: summaryList({
        rows: summaryRows(patient.record, {
          nhsn: { value: patient.record.formattedNhsNumber },
          fullName: {},
          preferredNames: { value: patient.preferredNames },
          dob: { value: patient.record.dobWithAge },
          sex: {},
          address: { value: patient.record.formattedAddress | nl2br },
          gpSurgery: {}
        })
      })
    }) }}

    {% set gillickDescriptionHtml %}
      {% if patient.gillick.competence %}
        {{ summaryList({
          rows: summaryRows(gillick, {
            competence: {
              value: patient.gillick.competence,
              href: session.uri + "/" + patient.nhsn + "/gillick/edit/competence"
            },
            assessment: {
              value: patient.gillick.assessment | nhsukMarkdown,
              href: session.uri + "/" + patient.nhsn + "/gillick/edit/assessment"
            }
          })
        }) }}
      {% else %}
        <p>
          <a href="{{ session.uri }}/{{ patient.nhsn }}/gillick/new">
            {{ __("gillick.start.confirm") }}
          </a>
        </p>
      {% endif %}
    {% endset %}

    {{ card({
      heading: __("gillick.label"),
      headingClasses: "nhsuk-heading-m",
      descriptionHtml: gillickDescriptionHtml
    }) if showGillick }}

    {% set consentDescriptionHtml %}
      {% if replies.length %}
        {%- set consentIcon = __("consent." + patient.consent.key + ".icon") -%}
        {%- set consentColour = __("consent." + patient.consent.key + ".colour") -%}
        <p class="app-status{{ " app-status--" + consentColour if consentColour }}">
          {{- icon(consentIcon) if consentIcon -}}
          {{- patient.consent.value -}}
        </p>

        {% set replyRows = [] %}
        {% for reply in replies %}
          {% set replyRows = replyRows | push([
            {
              header: __("parent.fullName.label"),
              html: "<span>" + link(reply.uri, reply.fullName) + ('<br><span class="nhsuk-u-font-size-16">' + reply.relationship + "</span></span>")
            },
            {
              header: __("reply.created.label"),
              html: reply.created | govukDate("truncate") or "Not provided",
              attributes: {
                "data-sort": reply.created
              }
            },
            {
              header: __("reply.decision.label"),
              text: reply.decision
            }
          ]) %}
        {% endfor %}

        {{ actionTable({
          classes: "nhsuk-u-margin-bottom-4",
          sort: "created",
          responsive: true,
          head: [
            { text: __("parent.fullName.label") },
            { text: __("reply.created.label") },
            { text: __("reply.decision.label") }
          ],
          rows: replyRows
        }) }}
      {% else %}
        {{ __("consent.NoResponse.description") | nhsukMarkdown }}
      {% endif %}
      <p>
        <a href="{{ session.uri }}/{{ patient.nhsn }}/replies/new">
          {{ __("patient.reply.start.confirm") }}
        </a>
      </p>
    {% endset %}

    {{ card({
      heading: __("consent.label"),
      headingClasses: "nhsuk-heading-m",
      descriptionHtml: consentDescriptionHtml
    }) }}

    {{ card({
      heading: __("healthAnswers.label"),
      headingClasses: "nhsuk-heading-m",
      descriptionHtml: summaryList({
        classes: "app-summary-list--full-width",
        rows: healthAnswerRows(campaign, replies)
      })
    }) if replies.length }}
  </div>
{% endblock %}
