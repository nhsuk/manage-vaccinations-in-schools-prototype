{% extends "_layouts/default.njk" %}

{% set dateOfBirth = true %}
{% set title = __("consent.match.title", { child: consent.child }) %}

{% block content %}
  {{ super() }}

  {{ heading({
    caption: __("consent.match.caption", { parent: consent.parent } ),
    title: title
  }) }}

  {% set filterCardHtml %}
    {{ input({
      label: { text: __("patient.filter.q") },
      decorate: "q"
    }) }}

    {{ details({
      text: __("patient.filter.advanced"),
      HTML: dateInput({
        fieldset: {
          legend: { text: __("patient.filter.dob") }
        },
        decorate: "dob"
      })
    }) }}

    <div class="app-button-group">
      {{ button({
        text: __("patient.filter.confirm")
      }) }}

      {{ button({
        classes: "app-button--secondary",
        text: __("patient.filter.clear"),
        href: "/consents/" + consent.uuid + "/match"
      }) if data.q }}
    </div>
  {% endset %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-one-third app-grid-column--sticky">
      {% set consentChildHtml %}
        {{ summaryList({
          classes: "nhsuk-u-margin-bottom-4 nhsuk-summary-list--no-border app-summary-list--full-width",
          rows: summaryRows(consent.child, {
            fullName: {},
            dob: {},
            postalCode: {},
            school: {}
          })
        }) }}

        {{ link(consentPath, "View full consent response") | nhsukMarkdown }}

        {{ button({
          href: consentPath + "/add",
          classes: "app-button--secondary",
          text: __("consent.add.label")
        }) }}
      {% endset %}

      {{ card({
        feature: true,
        heading: __("consent.label"),
        headingClasses: "nhsuk-heading-s",
        descriptionHtml: consentChildHtml
      }) }}
    </div>
    <div class="nhsuk-grid-column-two-thirds">
      {{ card({
        classes: "app-card--muted app-card--grey",
        feature: true,
        heading: __("patient.filter.label") ,
        headingClasses: "nhsuk-heading-s",
        descriptionHtml: filterCardHtml,
        attributes: {
          method: "post",
          role: "search"
        }
      }) | formCard }}

      {% if patients.length %}
        <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-2">Search results</h2>

        {{ __("patient.results", { results: results }) | nhsukMarkdown }}

        {% for patient in results.page %}
          {{ card({
            classes: "nhsuk-u-margin-bottom-3",
            heading: patient.fullName,
            headingClasses: "nhsuk-heading-s",
            clickable: true,
            href: consentPath + "/link?nhsn=" + patient.nhsn,
            descriptionHtml: summaryList({
              rows: summaryRows(patient, {
                dob: {},
                postalCode: {
                  value: patient.postalCode | highlightQuery(data.q)
                },
                school: {
                  value: patient.school.name | highlightQuery(data.q)
                },
                parents: {
                  value: patient.formatted.parents | highlightQuery(data.q)
                }
              })
            })
          }) }}
        {% endfor %}

        {{ govukPagination(pages) }}
      {% else %}
        <p class="nhsuk-caption-m">
          {{ __n("patient.count", patients.length) }}
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}
