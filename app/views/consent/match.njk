{% from "_macros/patient-search.njk" import appPatientSearch with context %}

{% extends "_layouts/form.njk" %}

{% set dateOfBirth = true %}
{% set gridColumns = "full" %}
{% set hideConfirmButton = true %}
{% set title = __("consent.match.title", { child: consent.child }) %}

{% block form %}
  {{ super() }}

  {{ appHeading({
    title: title
  }) }}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-one-third" data-module="app-sticky">
      {% call card({
        feature: true,
        heading: __("consent.label"),
        headingLevel: 3
      }) %}
        {{ summaryList({
          classes: "nhsuk-u-margin-bottom-4 nhsuk-summary-list--no-border app-summary-list--full-width",
          rows: summaryRows(consent.child, {
            fullAndPreferredNames: {
              label: __("consent.child.fullAndPreferredNames.label")
            },
            dob: {},
            postalCode: {},
            school: {},
            parent: {
              label: __("consent.parent.label"),
              value: consent.formatted.parent
            }
          })
        }) }}

        {{ link(consentPath + "?referrer=" + consentPath + "/match", "View full consent response") | nhsukMarkdown }}

        {{ button({
          href: consentPath + "/add",
          classes: "nhsuk-button--secondary",
          text: __("consent.add.label")
        }) }}
      {% endcall %}
    </div>

    <div class="nhsuk-grid-column-two-thirds">
      {{ appPatientSearch({
        hideProgrammeStatuses: true,
        clear: "/consents/" + consent.uuid + "/match"
      }) }}

      {% if initial %}
        {{ appHeading({
          level: 3,
          size: "m",
          title: __("search.results"),
          summary: __("search.initial") | safe
        }) }}
      {% else %}
        {{ appHeading({
          level: 3,
          size: "m",
          title: __("search.results"),
          summary: __mf("patient.results", {
            from: results.from,
            to: results.to,
            count: results.count
          }) | safe
        }) }}

        {% for patient in results.page %}
          {{ summaryList({
            card: {
              classes: "app-card--compact",
              heading: patient.fullName | highlightQuery(data.q),
              headingLevel: 4,
              clickable: true,
              href: consentPath + "/link?patient_uuid=" + patient.uuid
            },
            rows: summaryRows(patient, {
              dob: {},
              postalCode: {
                value: patient.postalCode | highlightQuery(data.q)
              },
              school: {
                value: patient.school.name | highlightQuery(data.q)
              },
              parents: {
                value: patient.formatted.parents | highlightQuery(data.q)
              }
            })
          }) }}
        {% endfor %}

        {{ pagination(pages) }}
      {% endif %}
    </div>
  </div>
{% endblock %}
