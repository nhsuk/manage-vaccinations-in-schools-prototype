{% from "../_macros/parent-email.njk" import appParentEmail %}
{% from "../_macros/parent-sms.njk" import appParentSms %}
{% from "patient-session/_navigation.njk" import patientSessionNavigation with context %}

{% extends "_layouts/form.njk" %}

{% set gridColumns = "full" %}
{% set hideConfirmButton = true %}
{% set title = patient.initials + " – " + session.location.name %}

{% block beforeContent %}
  {{ breadcrumb({
    items: [{
      text: __("home.show.title"),
      href: "/"
    }, {
      text: __("session.list.title"),
      href: "/sessions"
    }, {
      text: session.location.name,
      href: "/sessions/" + session.id
    }, {
      text: __("session." + activity + ".label"),
      href: "/sessions/" + session.id + "/" + activity
    }] if activity else [{
      text: __("home.show.title"),
      href: "/"
    }, {
      text: __("programme.list.title"),
      href: "/programmes"
    }, {
      text: patientSession.programme.name,
      href: "/programmes/" + patientSession.programme_id
    }, {
      text: __("programme.patients.title"),
      href: "/programmes/" + patientSession.programme_id + "/patients"
    }]
  }) }}
{% endblock %}

{% block form %}
  {{ super() }}

  {{ notificationBanner({
    text: __mf("patientSession.outstandingVaccinations.message", {
      count: patientSession.outstandingVaccinations.length,
      names: patientSession.formatted.outstandingVaccinations
    })
  }) if options.showOutstandingVaccinations }}

  {{ patientSessionNavigation({
    patientSession: patientSession,
    view: "show"
  }) }}

  <div class="nhsuk-grid-row">
    <div class="app-grid-column-patient-record" data-module="app-sticky">
      {{ appHeading({
        level: 3,
        size: "m",
        title: patientSession.patient.fullName
      }) }}

      {{ summaryList({
        classes: "nhsuk-u-margin-bottom-2 nhsuk-summary-list--no-border app-summary-list--full-width",
        rows: summaryRows(patient, {
          nhsn: {
            changeLabel: "the child’s NHS number",
            href: patient.uri + "/edit/nhsn" if patient.hasMissingNhsNumber
          },
          dob: {},
          address: {}
        })
      }) }}
      {{ link(patient.uri + "?referrer=" + referrer, "View full child record") | nhsukMarkdown }}
    </div>

    <div class="app-grid-column-patient-session">
      {% for auditEvent in patientSession.pinnedNotes %}
        {{ card({
          classes: "nhsuk-u-margin-top-3 app-card--yellow",
          heading: auditEvent.name,
          headingLevel: 4,
          feature: true,
          descriptionHtml: appEvent({ auditEvent: auditEvent, showProgrammes: true })
        }) }}
      {% endfor %}

      {% if options.canReport %}
        {% include "patient-session/_report.njk" %}
      {% else %}
        {{ appHeading({
          level: 3,
          size: "m",
          title: "Summary"
        }) }}

        {{ taskList({
          idPrefix: "summary",
          items: [
            {
              title: {
                text: __("patientSession.consent.title")
              },
              href: "#consent",
              status: {
                tag: statusTag(patientSession.status.consent)
              }
            },
            {
              title: {
                text: __("patientSession.screen.title")
              },
              href: "#screen" if options.canTriage,
              status: {
                tag: statusTag(patientSession.status.screen)
              } if options.canTriage else {
                text: "Cannot start yet",
                classes: "nhsuk-task-list__status--cannot-start-yet"
              }
            },
            {
              title: {
                text: __("session.instruct.label")
              },
              status: {
                tag: statusTag(patientSession.status.instruct)
              }
            } if session.psdProtocol and patientSession.instruct,
            {
              title: {
                text: __("patientSession.register.title")
              },
              href: "#register",
              status: {
                tag: statusTag(patientSession.status.register)
              }
            } if options.canRegister,
            {
              title: {
                text: __("patientSession.record.titleWithMethod", {
                  session: session,
                  method: patientSession.vaccine.method | lower
                }) if options.canRecord else __("patientSession.record.title")
              },
              href: "#record" if options.canRecord,
              status: {
                tag: statusTag(patientSession.status.outcome)
              } if options.canRecord else {
                text: "Cannot start yet",
                classes: "nhsuk-task-list__status--cannot-start-yet"
              }
            }
          ]
        }) }}
      {% endif %}

      {% include "patient-session/_consent.njk" %}

      {% if options.canTriage %}
        {% include "patient-session/_triage.njk" %}
      {% endif %}

      {% if options.canRegister %}
        {% include "patient-session/_register.njk" %}
      {% endif %}

      {% if options.canRecord %}
        {% include "patient-session/_record.njk" %}
      {% endif %}
    </div>
  </div>
{% endblock %}
