{% from "../_macros/parent-email.njk" import appParentEmail with context %}
{% from "../_macros/parent-sms.njk" import appParentSms with context %}
{% set isVaccinated = patientSession.report == PatientStatus.Vaccinated %}

{{ appHeading({
  level: 3,
  size: "m",
  title: __("session.consent.label")
}) }}

{% call card({
  feature: true,
  heading: programme.name + ": " + (patientSession.status.patientConsent.text),
  headingClasses: "app-card__heading--" + patientSession.status.patientConsent.colour,
  headingLevel: 4
}) %}
  {# Description #}
  {% if not isVaccinated %}
    {% if patientSession.patient.hasNoContactDetails %}
      {{ __("patientSession.hasNoContactDetails.description") | nhsukMarkdown }}
    {% elif session.consentWindow == ConsentWindow.Opening %}
      {{ session.formatted.consentWindowSentence | nhsukMarkdown }}
    {% else %}
      {{ patientSession.consentNotes | nhsukMarkdown }}
    {% endif %}

    {% if patientSession.patient.lastReminderDate %}
      {{ patientSession.patient.formatted.lastReminderDate | nhsukMarkdown }}
    {% endif %}
  {% endif %}

  {# Actions #}
  {{ appButtonGroup({
    buttons: [{
      classes: "nhsuk-button--secondary",
      text: __("remind.new.title"),
      attributes: {
        formaction: patientSession.uri + "/new/remind",
        formmethod: "post"
      }
    } if options.canRemind, {
      classes: "nhsuk-button--secondary",
      text: __("patientSession.invite.label"),
      attributes: {
        formaction: patientSession.uri + "/new/invite",
        formmethod: "post"
      }
    } if options.canInvite, {
      classes: "nhsuk-button--secondary",
      text: __("reply.new.title"),
      href: patientSession.uri + "/replies/new?referrer=" + referrer
    } if options.canRespond]
  }) if not isVaccinated }}

  {# Gillick #}
  {% if options.canGillick or patientSession.gillick %}
    {{ appHeading({
      level: 4,
      size: "s",
      title: __("patientSession.gillick.label")
    }) }}
    {{ appStatus(patientSession.gillick.formatted.competent) }}
  {% endif %}

  {% if options.canGillick and not isVaccinated %}
    {% set type = "edit" if patientSession.gillick.competent else "new" %}
    {{ button({
      classes: "nhsuk-button--secondary",
      text: __("patientSession.gillick." + type + ".title"),
      href: patientSession.uri + "/" + type + "/gillick?referrer=" + referrer
    }) }}
  {% endif %}

  {% if patientSession.replies | length %}
    {# Requests with responses or requests that couldn’t be delivered #}
    {{ appHeading({
      level: 4,
      size: "s",
      title: __("patientSession.replies.responses") if patientSession.responses.length > 0 else __("patientSession.replies.requests")
    }) }}

    {% for reply in patientSession.replies %}
      {{ card({
        classes: "app-card--compact app-card--offset",
        heading: reply.formatted.fullNameAndRelationship,
        headingLevel: 4,
        href: reply.uri if reply.delivered,
        clickable: true if reply.delivered,
        descriptionHtml: summaryList({
          rows: summaryRows(reply, {
            tel: {
              value: appParentSms(reply.parent, reply.given)
            } if reply.parent.tel,
            email: {
              value: appParentEmail(reply.parent, reply.given)
            } if reply.parent.email,
            createdAt: {},
            decisionStatus: {},
            vaccineCriteria: {}
          })
        })
      }) }}
    {% endfor %}
  {% elif not patientSession.patient.hasNoContactDetails %}
    {# Requests that have been sent but with no response yet #}
    {# We don’t create replies so use parent details instead #}

    {{ appHeading({
      level: 4,
      size: "s",
      title: __("patientSession.replies.pending")
    }) }}

    {% for parent in patientSession.patient.parents %}
      {{ card({
        classes: "app-card--compact app-card--offset",
        heading: parent.formatted.fullNameAndRelationship,
        headingLevel: 4,
        descriptionHtml: summaryList({
          rows: summaryRows(parent, {
            tel: {},
            email: {},
            createdAt: {},
            decisionStatus: {
              label: __("reply.decisionStatus.label"),
              value: tag({
                classes: "nhsuk-tag--grey",
                text: PatientConsentStatus.Scheduled if session.consentWindow == ConsentWindow.Opening else PatientConsentStatus.NoResponse
              })
            }
          })
        })
      }) if parent.email or parent.tel }}
    {% endfor %}
  {% endif %}

  {# Health answers #}
  {% if patientSession.consentHealthAnswers %}
    <hr class="nhsuk-section-break nhsuk-section-break--visible nhsuk-section-break--l">

    {{ appHeading({
      classes: "nhsuk-u-margin-bottom-2",
      level: 4,
      size: "s",
      title: __("healthAnswers.label")
    }) }}

    {{ summaryList({
      classes: "app-summary-list--full-width",
      rows: healthAnswerRows(patientSession.consentHealthAnswers)
    }) }}
  {% endif %}
{% endcall %}
