{% from "../_macros/parent-email.njk" import appParentEmail with context %}
{% from "../_macros/parent-sms.njk" import appParentSms with context %}
{% set isVaccinated = patientSession.report == PatientStatus.Vaccinated %}

{% call card({
  heading: __("patientSession.consent.title", programme.nameSentenceCase),
  headingLevel: 3
}) %}
  {# Description #}
  {% if not isVaccinated %}
    {{ patientSession.consentNotes | nhsukMarkdown }}

    {% if patientSession.patient.lastReminderDate %}
      {{ patientSession.patient.formatted.lastReminderDate | nhsukMarkdown }}
    {% endif %}
  {% endif %}

  {# Actions #}
  {{ appButtonGroup({
    buttons: [{
      classes: "nhsuk-button--secondary",
      text: __("remind.new.title"),
      attributes: {
        formaction: patientSession.uri + "/new/remind",
        formmethod: "post"
      }
    } if options.canRemind, {
      classes: "nhsuk-button--secondary",
      text: __("patientSession.invite.label"),
      attributes: {
        formaction: patientSession.uri + "/new/invite",
        formmethod: "post"
      }
    } if options.canInvite]
  }) if not isVaccinated }}

  {{ actionLink({
    text: __("reply.new.title"),
    href: patientSession.uri + "/replies/new?referrer=" + referrer
  }) if not isVaccinated }}

  {% if patientSession.replies | length %}
    {# Requests with responses or requests that couldn’t be delivered #}
    {{ appHeading({
      level: 4,
      size: "s",
      title: __("patientSession.replies.responses") if patientSession.responses.length > 0 else __("patientSession.replies.requests")
    }) }}

    {% for reply in patientSession.replies %}
      {{ card({
        classes: "app-card--compact app-card--offset",
        heading: reply.formatted.fullNameAndRelationship,
        headingLevel: 5,
        href: reply.uri if reply.delivered,
        clickable: true if reply.delivered,
        descriptionHtml: summaryList({
          rows: summaryRows(reply, {
            tel: {
              value: appParentSms(reply.parent, reply.given)
            } if reply.parent.tel,
            email: {
              value: appParentEmail(reply.parent, reply.given)
            } if reply.parent.email,
            createdAt: {},
            decisionStatus: {},
            vaccineCriteria: {}
          })
        })
      }) }}
    {% endfor %}
  {% elif not patientSession.patient.hasNoContactDetails %}
    {# Requests that have been sent but with no response yet #}
    {# We don’t create replies so use parent details instead #}

    {{ appHeading({
      level: 4,
      size: "s",
      title: __("patientSession.replies.pending")
    }) }}

    {% for parent in patientSession.patient.parents %}
      {{ card({
        classes: "app-card--compact app-card--offset",
        heading: parent.formatted.fullNameAndRelationship,
        headingLevel: 5,
        descriptionHtml: summaryList({
          rows: summaryRows(parent, {
            tel: {},
            email: {},
            createdAt: {},
            decisionStatus: {
              label: __("reply.decisionStatus.label"),
              value: tag({
                classes: "nhsuk-tag--grey",
                text: PatientConsentStatus.Scheduled if session.consentWindow == ConsentWindow.Opening else PatientConsentStatus.NoResponse
              })
            }
          })
        })
      }) if parent.email or parent.tel }}
    {% endfor %}
  {% endif %}

  {# Health answers #}
  {% if patientSession.consentHealthAnswers %}
    <hr class="nhsuk-section-break nhsuk-section-break--visible nhsuk-section-break--m">

    {{ appHeading({
      classes: "nhsuk-u-margin-bottom-2",
      level: 4,
      size: "s",
      title: __("healthAnswers.label")
    }) }}

    {{ summaryList({
      classes: "app-summary-list--full-width",
      rows: healthAnswerRows(patientSession.consentHealthAnswers)
    }) }}
  {% endif %}
{% endcall %}
