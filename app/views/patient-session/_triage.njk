{% set isVaccinated = patientSession.report == PatientStatus.Vaccinated %}

{{ appHeading({
  level: 3,
  size: "m",
  title: __("session.screen.label")
}) }}

{% call card({
  feature: true,
  heading: programme.name + ": " + (patientSession.status.screen.text),
  headingClasses: "app-card__heading--" + patientSession.status.screen.colour,
  headingLevel: 4
}) %}
  {# Description #}
  {{ patientSession.screenNotes | nhsukMarkdown }}

  {# Actions #}
  {{ appButtonGroup({
    buttons: [{
      classes: "nhsuk-button--secondary",
      text: __("triage.edit.title"),
      href: patientSession.uri + "/edit/triage?referrer=" + referrer
    }]
  }) if not options.needsTriage and not isVaccinated }}

  {# Decision table #}
  {% set triageNoteRows = [] %}
  {% for triageNote in patientSession.triageNotes | reverse %}
    {% set triageNoteRows = triageNoteRows | push([
      {
        header: __("event.createdAt.label"),
        html: triageNote.summary.createdAtAndBy
      },
      {
        header: __("event.note.label"),
        html: triageNote.note or "â€”" | nhsukMarkdown
      },
      {
        header: __("event.outcome.label"),
        html: triageNote.formatted.outcome
      }
    ]) %}
  {% endfor %}

  {% if options.hasTriage %}
    {{ table({
      id: "triage-notes",
      caption: __("triage.note.label"),
      responsive: true,
      head: [
        {
          text: __("event.createdAt.label"),
          attributes: {
            width: "25%"
          }
        },
        { text: __("event.note.label") },
        {
          text: __("event.outcome.label"),
          attributes: {
            width: "25%"
          }
        }
      ],
      rows: triageNoteRows
    }) }}
  {% endif %}

  {% if options.needsTriage %}
    <hr class="nhsuk-section-break nhsuk-section-break--visible nhsuk-section-break--l">

    {% set psdRadiosHtml = radios({
      classes: "nhsuk-radios--inline",
      fieldset: { legend: { text: __("triage.psd.label") } },
      items: booleanItems,
      decorate: "triage.psd"
    }) if account.canPrescribe %}

    {% set delayVaccinationHtml = dateInput({
      fieldset: {
        legend: {
          classes: "nhsuk-fieldset__legend--s",
          text: __("triage.outcomeAt.title", { patient: patient })
        }
      },
      hint: { text: __("triage.outcomeAt.hint", { date: DelayDate }) },
      decorate: "triage.outcomeAt_"
    }) %}

    {% set outcomeItems = injectConditionalHtml(triageOutcomeItems(patientSession.screenOutcomesForConsentMethod), ScreenOutcome.VaccinateIntranasal, psdRadiosHtml) if patientSession.programme.alternativeVaccine else triageOutcomeItems(patientSession.screenOutcomesForConsentMethod) %}

    {{ radios({
      fieldset: {
        legend: {
          classes: "nhsuk-fieldset__legend--m nhsuk-u-font-size-22",
          text: __("triage.label", { patient: patient })
        }
      },
      hint: {
        text: patientSession.screenVaccineCriteria
      } if patientSession.screenVaccineCriteria,
      items: injectConditionalHtml(outcomeItems, ScreenOutcome.DelayVaccination, delayVaccinationHtml),
      decorate: "triage.outcome"
    }) }}

    {{ textarea({
      label: {
        text: __("triage.note.label") + " (optional)"
      },
      rows: 5,
      decorate: "triage.note"
    }) }}

    {{ button({
      text: __("triage.confirm"),
      attributes: {
        formaction: patientSession.uri + "/new/triage?referrer=" + referrer
      }
    }) }}
  {% endif %}
{% endcall %}
