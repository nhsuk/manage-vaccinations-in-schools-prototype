{% call card({
  heading: "Session in progress" if session.isActive else session.status,
  headingLevel: 3
}) %}
  {% if session.isActive or session.isCompleted %}
    {{ insetText({
      classes: "nhsuk-u-margin-top-4 nhsuk-u-margin-bottom-4",
      html: link(session.uri + "/report?options=stillToVaccinate", __mf("session.activity.stillToVaccinate.count", {
        count: session.activity.stillToVaccinate
      })) | nhsukMarkdown
    }) }}

    {% set rows = [] %}
    {# Add a row for each session date #}
    {% for dateShort in session.formatted.datesShort %}
      {% set dateRow = [{
        header: __("session.date.label"),
        html: dateShort
      }] %}
      {% for programme in session.programmes %}
        {% if programme.standardVaccine.criteria == VaccineCriteria.Intranasal %}
          {% set dateRow = dateRow.concat([{
            header: __("session.tally.vaccinatedIntranasal.label", {
              programme: programme
            }) | safe,
            text: session.tally(programme.id).vaccinatedIntranasal if loop.first else 0,
            format: "numeric"
          }]) %}
        {% else %}
          {% set dateRow = dateRow.concat([{
            header: programme.name,
            text: session.tally(programme.id).vaccinated if loop.first else 0,
            format: "numeric"
          }]) %}
        {% endif %}
        {% if programme.alternativeVaccine %}
          {% set dateRow = dateRow.concat([{
            header: __("session.tally.vaccinatedAlternativeInjection.label", {
              programme: programme
            }) | safe,
            text: session.tally(programme.id).vaccinatedAlternativeInjection if loop.first else 0,
            format: "numeric"
          }]) %}
        {% endif %}
      {% endfor %}
      {% set rows = rows | push(dateRow) %}
    {% endfor %}

    {# Add a row for total across all session dates #}
    {% set totalRow = [{
      header: "All dates",
      text: "Total"
    }] %}
    {% for programme in session.programmes %}
      {% if programme.standardVaccine.criteria == VaccineCriteria.Intranasal %}
        {% set totalRow = totalRow.concat([{
          header: __("session.tally.vaccinatedIntranasal.label", {
            programme: programme
          }) | safe,
          html: "<strong>" + session.tally(programme.id).vaccinatedIntranasal   + "</strong>",
          format: "numeric"
        }]) %}
      {% else %}
        {% set totalRow = totalRow.concat([{
          header: programme.name,
          html: "<strong>" + session.tally(programme.id).vaccinated + "</strong>",
          format: "numeric"
        }]) %}
      {% endif %}
      {% if programme.alternativeVaccine %}
        {% set totalRow = totalRow.concat([{
          header: __("session.tally.vaccinatedAlternativeInjection.label", {
            programme: programme
          }) | safe,
          html: "<strong>" + session.tally(programme.id).vaccinatedAlternativeInjection + "</strong>",
          format: "numeric"
        }]) %}
      {% endif %}
    {% endfor %}
    {% set rows = rows | push(totalRow) %}

    {# Head row #}
    {% set head = [{
      text: __("session.date.label")
    }] %}
    {% for programme in session.programmes %}
      {% if programme.standardVaccine.criteria == VaccineCriteria.Intranasal %}
        {% set head = head.concat([{
          text: __("session.tally.vaccinatedIntranasal.label", {
            programme: programme
          }),
          format: "numeric"
        }]) %}
      {% else %}
        {% set head = head.concat([{
          text: programme.name,
          format: "numeric"
        }]) %}
      {% endif %}
      {% if programme.alternativeVaccine %}
        {% set head = head.concat([{
          text: __("session.tally.vaccinatedAlternativeInjection.label", {
            programme: programme
          }),
          format: "numeric"
        }]) %}
      {% endif %}
    {% endfor %}

    {{ table({
      id: "dates",
      caption: __("session.tally.vaccinated.caption"),
      responsive: true,
      head: head,
      rows: rows
    }) }}
  {% else %}
    {{ session.formatted.dates | safe }}

    {{ session.formatted.consentWindow | nhsukMarkdown if session.type == SessionType.School }}
  {% endif %}

  {{ appButtonGroup({
    buttons: [
      {
        classes: "nhsuk-button--secondary",
        text: __("session.schedule.title") if session.isUnplanned else __("session.edit.title"),
        href: session.uri + "/edit"
      },
      {
        classes: "nhsuk-button--secondary",
        text: __("session.close.title"),
        href: session.uri + "/close"
      } if session.isCompleted
    ],
    links: [{
      classes: "nhsuk-button--secondary",
      text: __("session.offline.title"),
      href: session.uri + "/offline"
    }] if session.isPlanned
  }) }}
{% endcall %}
