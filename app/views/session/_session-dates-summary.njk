{% call card({
  heading: "Session in progress" if session.isActive else session.status,
  headingLevel: 3
}) %}
  {% if session.isActive or session.isCompleted %}
    {{ insetText({
      classes: "nhsuk-u-margin-top-4 nhsuk-u-margin-bottom-4",
      html: link(session.uri + "/report?options=stillToVaccinate", __mf("session.activity.stillToVaccinate.count", {
        count: session.activity.stillToVaccinate
      })) | nhsukMarkdown
    }) }}

    {% set rows = [] %}
    {# Add a row for each session date #}
    {% for dateShort in session.formatted.datesShort %}
      {% set dateRow = [{
        header: __("session.date.label"),
        html: dateShort
      }] %}
      {% if session.offersAlternativeVaccine %}
        {% set programme = session.primaryProgrammes[0] %}
        {% set dateRow = dateRow.concat([{
          header: __("session.tally.vaccinated.label", {
            programme: programme,
            vaccineMethod: programme.standardVaccine.method | lower
          }) | safe,
          text: session.tally(programme.id).vaccinatedStandard if loop.first else 0,
          format: "numeric"
        }, {
          header: __("session.tally.vaccinated.label", {
            programme: programme,
            vaccineMethod: programme.alternativeVaccine.method | lower
          }) | safe,
          text: session.tally(programme.id).vaccinatedAlternative if loop.first else 0,
          format: "numeric"
        }]) %}
      {% else %}
        {% for programme in session.primaryProgrammes %}
          {% set dateRow = dateRow.concat([{
            header: __("session.tally.vaccinated.label", {
              programme: programme,
              vaccineMethod: programme.standardVaccine.method | lower
            }) | safe,
            text: session.tally(programme.id).vaccinated if loop.first else 0,
            format: "numeric"
          }]) %}
        {% endfor %}
      {% endif %}
      {% set rows = rows | push(dateRow) %}
    {% endfor %}

    {# Add a row for total across all session dates #}
    {% set totalRow = [{
      header: "All dates",
      text: "Total"
    }] %}
    {% if session.offersAlternativeVaccine %}
      {% set programme = session.primaryProgrammes[0] %}
      {% set totalRow = totalRow.concat([{
        header: __("session.tally.vaccinated.label", {
          programme: programme,
          vaccineMethod: programme.standardVaccine.method | lower
        }) | safe,
        html: "<strong>" + session.tally(programme.id).vaccinatedStandard + "</strong>",
        format: "numeric"
      }, {
        header: __("session.tally.vaccinated.label", {
          programme: programme,
          vaccineMethod: "gelatine-free injection"
        }) | safe,
        html: "<strong>" + session.tally(programme.id).vaccinatedAlternative + "</strong>",
        format: "numeric"
      }]) %}
    {% else %}
      {% for programme in session.primaryProgrammes %}
        {% set totalRow = totalRow.concat([{
          header: __("session.tally.vaccinated.label", {
            programme: programme,
            vaccineMethod: programme.standardVaccine.method | lower
          }) | safe,
          html: "<strong>" + session.tally(programme.id).vaccinated + "</strong>",
          format: "numeric"
        }]) %}
      {% endfor %}
    {% endif %}
    {% set rows = rows | push(totalRow) %}

    {# Head row #}
    {% set head = [{
      text: __("session.date.label")
    }] %}
    {% if session.offersAlternativeVaccine %}
      {% set programme = session.primaryProgrammes[0] %}
      {% set head = head.concat([{
        text: __("session.tally.vaccinated.label", {
          programme: programme,
          vaccineMethod: programme.standardVaccine.method | lower
        }),
        format: "numeric"
      }, {
        text: __("session.tally.vaccinated.label", {
          programme: programme,
          vaccineMethod: "gelatine-free injection"
        }),
        format: "numeric"
      }]) %}
    {% else %}
      {% for programme in session.primaryProgrammes %}
        {% set head = head.concat([{
          text: programme.name,
          format: "numeric"
        }]) %}
      {% endfor %}
    {% endif %}

    {{ table({
      id: "dates",
      caption: __("session.tally.vaccinated.caption"),
      responsive: true,
      head: head,
      rows: rows
    }) }}
  {% else %}
    {{ session.formatted.dates | safe }}

    {{ session.formatted.consentWindow | nhsukMarkdown if session.type == SessionType.School }}
  {% endif %}

  {{ appButtonGroup({
    buttons: [
      {
        classes: "nhsuk-button--secondary",
        text: __("session.schedule.title") if session.isUnplanned else __("session.edit.title"),
        href: session.uri + "/edit"
      },
      {
        classes: "nhsuk-button--secondary",
        text: __("session.close.title"),
        href: session.uri + "/close"
      } if session.isCompleted
    ],
    links: [{
      classes: "nhsuk-button--secondary",
      text: __("session.offline.title"),
      href: session.uri + "/offline"
    }] if session.isPlanned
  }) }}
{% endcall %}
