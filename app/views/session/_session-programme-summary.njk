{%- from "nhsuk/components/tabs/macro.njk" import tabs -%}

{% macro programmeHtml(programme) %}
  {% set columnWidth = "quarter" if session.offersAlternativeVaccine or programme.type == ProgrammeType.MMR else "third" %}

  {{ appHeading({
    title: programme.name,
    summary: __mf("session.eligible.count", {
      count: session.patients.length
    }),
    level: 3,
    size: "m"
  }) }}

  <div class="nhsuk-grid-row nhsuk-card-group">
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.Consent,
        headingLevel: 3,
        colour: "blue",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Consent),
        href: session.uri + "/report?report=" + PatientStatus.Consent + "&programme_id=" + programme.id
      }) }}
    </div>
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.Triage,
        headingLevel: 3,
        colour: "blue",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Triage),
        href: session.uri + "/report?report=" + PatientStatus.Triage + "&programme_id=" + programme.id
      }) }}
    </div>
  {% if programme.type == ProgrammeType.Flu %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: __("session.tally.dueForVaccineCriteria.label", {
          vaccineCriteria: programme.standardVaccine.criteria | lower
        }),
        colour: "green",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Due, RecordVaccineCriteria.IntranasalOnly) + session.tally(programme.id, PatientStatus.Due, RecordVaccineCriteria.IntranasalPreferred),
        href: session.uri + "/report?report=" + PatientStatus.Due + "&programme_id=" + programme.id + "&vaccineCriteria=" + RecordVaccineCriteria.IntranasalOnly + "&vaccineCriteria=" + RecordVaccineCriteria.IntranasalPreferred
      }) }}
    </div>
  {% elif programme.type == ProgrammeType.MMR %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: __("session.tally.dueForVaccineCriteria.label", {
          vaccineCriteria: "vaccination (no preference)"
        }),
        colour: "green",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Due, RecordVaccineCriteria.NoMMRPreference),
        href: session.uri + "/report?report=" + PatientStatus.Due + "&programme_id=" + programme.id + "&vaccineCriteria=" + RecordVaccineCriteria.NoMMRPreference
      }) }}
    </div>
  {% else %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.Due,
        headingLevel: 3,
        colour: "green",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Due),
        href: session.uri + "/report?report=" + PatientStatus.Due + "&programme_id=" + programme.id
      }) }}
    </div>
  {% endif %}
  {% if programme.alternativeVaccine %}
    {% set vaccineCriteria = RecordVaccineCriteria.AlternativeFluInjectionOnly if programme.type == ProgrammeType.Flu else RecordVaccineCriteria.AlternativeMMRInjectionOnly %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: __("session.tally.dueForVaccineCriteria.label", {
          vaccineCriteria: vaccineCriteria | lower
        }),
        colour: "green",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Due, vaccineCriteria),
        href: session.uri + "/report?report=" + PatientStatus.Due + "&programme_id=" + programme.id + "&vaccineCriteria=" + vaccineCriteria
      }) }}
    </div>
  {% endif %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.Refused,
        headingLevel: 3,
        colour: "orange",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Refused),
        href: session.uri + "/report?report=" + PatientStatus.Refused + "&programme_id=" + programme.id
      }) }}
    </div>
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.Deferred,
        headingLevel: 3,
        colour: "red",
        compact: true,
        data: session.tally(programme.id, PatientStatus.Deferred),
        href: session.uri + "/report?report=" + PatientStatus.Deferred + "&programme_id=" + programme.id
      }) }}
    </div>
  {% if programme.type == ProgrammeType.MMR or programme.type == ProgrammeType.Flu %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.PartiallyVaccinated,
        headingLevel: 3,
        compact: true,
        data: session.tally(programme.id, PatientStatus.PartiallyVaccinated),
        href: session.uri + "/report?report=" + PatientStatus.PartiallyVaccinated + "&programme_id=" + programme.id
      }) }}
    </div>
  {% endif %}
    <div class="nhsuk-grid-column-one-{{ columnWidth }} nhsuk-card-group__item">
      {{ appDataCard({
        heading: PatientStatus.Vaccinated,
        headingLevel: 3,
        compact: true,
        data: session.tally(programme.id, PatientStatus.Vaccinated),
        href: session.uri + "/report?report=" + PatientStatus.Vaccinated + "&programme_id=" + programme.id
      }) }}
    </div>
  </div>
{% endmacro %}

{% set tabItems = [] %}
{% for programme in session.programmes %}
  {% set tabItems = tabItems | push({
    label: programme.name,
    id: programme.id,
    panel: {
      html: programmeHtml(programme)
    }
  }) %}
{% endfor %}

{{ tabs({
  items: tabItems
}) if session.programmes.length > 1 else programmeHtml(session.programmes[0]) }}
